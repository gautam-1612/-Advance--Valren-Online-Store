<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../includes/head.ejs') %>
    <link rel="stylesheet" href="/css/checkout.css" />
    <link rel="stylesheet" href="/css/cart.css" />
  </head>

  <body>
    <%- include('../includes/navigation.ejs') %>
    <!-- calculations -->
    <% const shippingCost = totalPrice >= 5000 ? 0 : 500; const gstAmount =
    Math.round(totalPrice * 0.12); const finalPayable = totalPrice + gstAmount +
    shippingCost; %>

    <main class="checkout-container">
      <h1 class="checkout_heading">Checkout</h1>

      <div class="checkout-wrapper">
        <!-- LEFT SECTION: ADDRESS ONLY -->
        <section class="section_1">
          <div class="card">
            <h2 class="section-title">Billing Details</h2>

            <form
              id="checkout-form"
              action="/create-order"
              method="POST"
              class="checkout-form"
            >
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <input
                type="hidden"
                name="finalPayable"
                value="<%= finalPayable %>"
              />
              <div id="form-error" style="color: red; margin-bottom: 8px"></div>

              <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="fullName" required />
              </div>

              <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required />
              </div>

              <div class="form-group">
                <label>Phone</label>
                <input type="text" name="phone" required />
              </div>

              <div class="form-group">
                <label>Address</label>
                <textarea name="address" rows="3" required></textarea>
              </div>

              <div class="centered">
                <button id="order-btn" type="button" class="place-order-btn">
                  Place Order
                </button>
                <script src="http://js.stripe.com/v3/"></script>
                <script>
                  var stripe = Stripe("<%= publishableKey %>");
                  var orderBtn = document.getElementById("order-btn");
                  const errorBox = document.getElementById("form-error"); // ✅ Add this line
                  errorBox.textContent = ""; // clear previous errors
                  orderBtn.addEventListener("click", async () => {
                    const form = document.getElementById("checkout-form");
                    const formData = new FormData(form);

                    const result = await fetch("/start-checkout", {
                      method: "POST",
                      body: formData,
                      credentials: "include",
                      headers: {
                        "CSRF-Token": formData.get("_csrf"),
                      },
                    });

                    const data = await result.json();
                    if (data.error) {
                      errorBox.textContent = data.error;
                      return;
                    }

                    if (data.url) {
                      window.location = data.url;
                    } else {
                      alert(
                        "Payment session could not be created. Check console."
                      );
                    }
                  });
                </script>
              </div>
            </form>
          </div>
        </section>

        <div class="v-line"></div>

        <!-- RIGHT SECTION: ORDER SUMMARY -->
        <section class="section_2">
          <div class="total first_total">
            <h2 class="total_price">Total Cost</h2>
            <p>₹ <%= totalPrice %></p>
          </div>

          <div class="total">
            <h2 class="total_price secondary_price">Shipping</h2>
            <p>
              <% if (shippingCost === 0) { %> Free <% } else { %> ₹ <%=
              shippingCost %> <% } %>
            </p>
          </div>

          <div class="total">
            <h2 class="total_price secondary_price">GST (12%)</h2>
            <p>₹ <%= gstAmount %></p>
          </div>

          <div class="total">
            <h2 class="total_price">Total Payable</h2>
            <p class="finalPayable">₹ <%= finalPayable %></p>
          </div>

          <p
            style="
              margin-top: 10px;
              font-size: 0.85rem;
              opacity: 0.7;
              text-align: center;
            "
          >
            <% if (shippingCost === 0) { %> Shipping is free for orders above
            ₹5000 <% } else { %> Shipping fee added for orders below ₹5000 <% }
            %>
          </p>
        </section>
      </div>
    </main>
  </body>
</html>
